<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timeless Trends</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    /* Mobile-First CSS */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: #f5f5f5;
      color: #333;
      font-size: 14px;
      line-height: 1.5;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #8a2387, #e94057, #f27121);
      padding: 15px;
      color: white;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .nav-container {
      display: flex;
      flex-direction: column;
      padding: 10px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 10px;
      gap: 10px;
    }

    .search-bar {
      padding: 12px 15px;
      width: 100%;
      border-radius: 25px;
      border: 1px solid #ddd;
      font-size: 14px;
      outline: none;
    }

    .user-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .cart-button, .auth-button {
      background: #8a2387;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 25px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background 0.3s;
    }

    .cart-button:hover, .auth-button:hover {
      background: #6a1b6b;
    }

    .products {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px;
    }

    .product-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .product-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .product-card h3 {
      font-size: 14px;
      margin: 5px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-card p {
      font-size: 12px;
      margin: 3px 0;
      color: #666;
    }

    .product-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    .wishlist-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      color: #ccc;
      transition: color 0.3s;
    }

    .wishlist-btn.active {
      color: #e94057;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px 0;
    }

    .modal-content {
      background: white;
      margin: 0 auto;
      padding: 20px;
      border-radius: 12px;
      width: 95%;
      max-width: 400px;
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 22px;
      cursor: pointer;
      color: #888;
      transition: color 0.3s;
    }

    .close-btn:hover {
      color: #333;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
    }

    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      color: #888;
      font-weight: 500;
      transition: all 0.3s;
    }

    .auth-tab.active {
      color: #8a2387;
      font-weight: 600;
      border-bottom: 2px solid #8a2387;
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .auth-form input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .auth-form button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #8a2387, #e94057);
      color: white;
      border: none;
      border-radius: 6px;
      margin-top: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .auth-form button:hover {
      opacity: 0.9;
    }

    .auth-error {
      color: #e94057;
      font-size: 12px;
      margin-top: 5px;
      text-align: center;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      gap: 10px;
    }

    .cart-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
    }

    .cart-item-info {
      flex: 1;
    }

    .cart-item-name {
      font-weight: 500;
      margin-bottom: 3px;
      font-size: 14px;
    }

    .cart-item-price {
      font-size: 12px;
      color: #666;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quantity-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: #8a2387;
      color: white;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-btn {
      background: none;
      border: none;
      color: #e94057;
      font-size: 12px;
      cursor: pointer;
      margin-left: 10px;
    }

    .cart-total {
      text-align: right;
      margin: 15px 0;
      font-size: 16px;
      font-weight: 600;
    }

    .cart-actions {
      display: flex;
      gap: 10px;
    }

    .checkout-steps {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }

    .checkout-step {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      position: relative;
      font-size: 12px;
      color: #888;
    }

    .checkout-step.active {
      color: #8a2387;
      font-weight: 600;
    }

    .checkout-step.completed {
      color: #4CAF50;
    }

    .checkout-step.active:after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 2px;
      background: #8a2387;
    }

    .checkout-section {
      display: none;
    }

    .checkout-section.active {
      display: block;
    }

    .section-title {
      font-size: 16px;
      margin-bottom: 15px;
      color: #333;
      font-weight: 600;
    }

    .form-row {
      margin-bottom: 12px;
    }

    .form-row label {
      display: block;
      margin-bottom: 5px;
      font-size: 13px;
      color: #555;
    }

    .form-row input, 
    .form-row select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .payment-method {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .payment-method:hover {
      border-color: #bbb;
    }

    .payment-method.active {
      border-color: #8a2387;
      background: #f9f0ff;
    }

    .payment-method input {
      margin-right: 10px;
    }

    .payment-method-label {
      display: flex;
      align-items: center;
      width: 100%;
    }

    .payment-method-icon {
      width: 30px;
      height: 30px;
      object-fit: contain;
      margin-right: 10px;
    }

    .payment-details {
      display: none;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 6px;
      margin-top: 5px;
      font-size: 12px;
      line-height: 1.6;
      border: 1px solid #eee;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .payment-details.active {
      display: block;
    }

    .payment-details p {
      margin-bottom: 5px;
    }

    .payment-details strong {
      color: #333;
    }

    .checkout-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      gap: 10px;
    }

    .btn-back {
      background: #f5f5f5;
      color: #333;
      border: none;
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      flex: 1;
      font-weight: 500;
    }

    .btn-next, 
    .btn-confirm {
      background: linear-gradient(135deg, #8a2387, #e94057);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      flex: 1;
      font-weight: 500;
      transition: opacity 0.3s;
    }

    .btn-next:hover,
    .btn-confirm:hover {
      opacity: 0.9;
    }

    .order-summary {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .order-summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .order-summary-total {
      font-weight: 600;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      font-size: 15px;
    }

    .free-shipping {
      margin-top: 15px;
      padding: 10px;
      background: #f0fff0;
      border-radius: 6px;
      color: #4CAF50;
      font-size: 12px;
      text-align: center;
      display: none;
    }

    .popup {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #8a2387;
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    .dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }

    .dark-mode .nav-container,
    .dark-mode .product-card,
    .dark-mode .modal-content {
      background-color: #1e1e1e;
      color: #f0f0f0;
    }

    .dark-mode .search-bar,
    .dark-mode .form-row input,
    .dark-mode .form-row select,
    .dark-mode .payment-details {
      background-color: #2a2a2a;
      color: #f0f0f0;
      border-color: #444;
    }

    .dark-mode .product-card p,
    .dark-mode .cart-item-price,
    .dark-mode .form-row label {
      color: #bbb;
    }

    .dark-mode .payment-method {
      background-color: #2a2a2a;
      border-color: #444;
    }

    .dark-mode .payment-details {
      background-color: #333;
      border-color: #444;
    }

    @media (min-width: 768px) {
      .products {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .nav-container {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
      
      .search-bar {
        width: 200px;
        margin-bottom: 0;
      }
      
      .user-greeting {
        display: inline;
        margin-right: 10px;
        font-size: 14px;
      }
    }
    .user-greeting {
  margin-right: 10px;
  font-size: 14px;
  display: none; /* Hidden by default on mobile */
}

@media (min-width: 768px) {
  .user-greeting {
    display: inline; /* Show on larger screens */
  }
}
  </style>
</head>
<body>
  <!-- Header -->
  <header>Timeless Trends</header>
  
  <!-- Navigation -->
  <div class="nav-container">
    <input type="text" class="search-bar" placeholder="Search products...">
    <div class="user-controls">
      <span id="userGreeting" class="user-greeting"></span>
      <button class="cart-button" onclick="viewWishlist()"><i class="far fa-heart"></i> Wishlist</button>
      <button id="authButton" class="auth-button" onclick="openAuthModal()"><i class="far fa-user"></i> Login</button>
      <button class="cart-button" onclick="toggleDarkMode()"><i class="far fa-moon"></i> Dark</button>
      <button class="cart-button" onclick="openCart()"><i class="fas fa-shopping-cart"></i> Cart</button>
    </div>
  </div>
  
  <!-- Product List -->
  <section class="products" id="product-list">
    <!-- Products will be loaded here -->
  </section>
  
  <!-- Auth Modal -->
  <div id="authModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeAuthModal()">&times;</span>
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
        <div class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</div>
      </div>
      
      <div id="loginForm" class="auth-form active">
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button class="btn-confirm" onclick="login()">Login</button>
        <p id="loginError" class="auth-error"></p>
      </div>
      
      <div id="signupForm" class="auth-form">
        <input type="text" id="signupName" placeholder="Full Name">
        <input type="email" id="signupEmail" placeholder="Email">
        <input type="password" id="signupPassword" placeholder="Password">
        <input type="password" id="signupConfirmPassword" placeholder="Confirm Password">
        <button class="btn-confirm" onclick="signup()">Sign Up</button>
        <p id="signupError" class="auth-error"></p>
      </div>
    </div>
  </div>
  
  <!-- Cart Modal -->
  <div id="cartModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeCart()">&times;</span>
      <h2>Your Cart</h2>
      <div id="cartItems"></div>
      <div id="couponSection" style="margin: 15px 0;">
        <input type="text" id="couponCode" placeholder="Enter coupon code" style="padding: 8px; width: 60%;">
        <button onclick="applyCoupon()" style="padding: 8px 15px; margin-left: 10px;">Apply</button>
        <p id="couponMessage" style="font-size: 12px; margin-top: 5px;"></p>
      </div>
      <p style="text-align: right; margin: 10px 0;"><strong>Total: PKR <span id="totalPrice">0</span></strong></p>
      <div style="display: flex; gap: 10px;">
        <button class="btn-back" onclick="closeCart()">Close</button>
        <button class="btn-confirm" onclick="openCheckout()">Checkout</button>
      </div>
    </div>
  </div>
  
  <!-- Checkout Modal -->
  <div id="checkoutModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeCheckout()">&times;</span>
      
      <div class="checkout-steps">
        <div class="checkout-step active" id="step1">1. Info</div>
        <div class="checkout-step" id="step2">2. Shipping</div>
        <div class="checkout-step" id="step3">3. Payment</div>
      </div>
      
      <!-- Step 1: Customer Information -->
      <div class="checkout-section active" id="section1">
        <h3 style="margin-bottom: 10px;">Contact Information</h3>
        <div class="form-row">
          <input type="email" id="checkoutEmail" placeholder="Email">
        </div>
        
        <h3 style="margin: 15px 0 10px;">Shipping Address</h3>
        <div class="form-row">
          <input type="text" id="checkoutName" placeholder="Full Name">
        </div>
        <div class="form-row">
          <input type="text" id="checkoutAddress" placeholder="Street Address">
        </div>
        <div class="form-row">
          <select id="checkoutProvince">
            <option value="">Select Province</option>
            <option value="Punjab">Punjab</option>
            <option value="Sindh">Sindh</option>
            <option value="KPK">Khyber Pakhtunkhwa</option>
            <option value="Balochistan">Balochistan</option>
          </select>
        </div>
        <div class="form-row">
          <input type="text" id="checkoutCity" placeholder="City">
        </div>
        <div class="form-row">
          <input type="tel" id="checkoutContact" placeholder="Phone Number">
        </div>
        
        <div class="checkout-actions">
          <button class="btn-back" onclick="closeCheckout()">Cancel</button>
          <button class="btn-next" onclick="goToStep(2)">Continue</button>
        </div>
      </div>
      
      <!-- Step 2: Shipping Method -->
      <div class="checkout-section" id="section2">
        <h3 style="margin-bottom: 15px;">Shipping Method</h3>
        
        <div class="payment-method active">
          <input type="radio" name="shipping" id="standardShipping" checked>
          <label class="payment-method-label" for="standardShipping">
            <div>
              <strong>Standard Shipping</strong>
              <div style="font-size: 12px; color: #666;">3-5 business days</div>
            </div>
            <div style="margin-left: auto;">PKR 300</div>
          </label>
        </div>
        
        <div class="payment-method">
          <input type="radio" name="shipping" id="expressShipping">
          <label class="payment-method-label" for="expressShipping">
            <div>
              <strong>Express Shipping</strong>
              <div style="font-size: 12px; color: #666;">1-2 business days</div>
            </div>
            <div style="margin-left: auto;">PKR 800</div>
          </label>
        </div>
        
        <div class="checkout-actions">
          <button class="btn-back" onclick="goToStep(1)">Back</button>
          <button class="btn-next" onclick="goToStep(3)">Continue</button>
        </div>
      </div>
      
      <!-- Step 3: Payment -->
      <div class="checkout-section" id="section3">
        <h3 style="margin-bottom: 15px;">Payment Method</h3>
        
        <div class="payment-method active">
          <input type="radio" name="payment" id="cashOnDelivery" checked>
          <label class="payment-method-label" for="cashOnDelivery">
            <img src="https://cdn-icons-png.flaticon.com/512/2553/2553610.png" class="payment-method-icon">
            <span>Cash on Delivery</span>
          </label>
        </div>
        
        <div class="payment-method">
          <input type="radio" name="payment" id="easyPaisa">
          <label class="payment-method-label" for="easyPaisa">
            <img src="https://play-lh.googleusercontent.com/PCpXdqvUWfCW1mXhH1Y_98yBpgsWxuTSTofy3NGMo9yBTATDyzVkqU580bfSln50bFU" class="payment-method-icon">
            <span>EasyPaisa</span>
          </label>
        </div>
        <div id="easyPaisaDetails" class="payment-details">
          <p>Please send payment to:</p>
          <p><strong>Account Number:</strong> 0312-3456789</p>
          <p><strong>Account Name:</strong> Timeless Trends</p>
          <p>After payment, share transaction ID via WhatsApp at 0312-3456789</p>
        </div>
        
        <div class="payment-method">
          <input type="radio" name="payment" id="jazzcash">
          <label class="payment-method-label" for="jazzcash">
            <img src="https://play-lh.googleusercontent.com/PCpXdqvUWfCW1mXhH1Y_98yBpgsWxuTSTofy3NGMo9yBTATDyzVkqU580bfSln50bFU" class="payment-method-icon">
            <span>JazzCash</span>
          </label>
        </div>
        <div id="jazzcashDetails" class="payment-details">
          <p>Please send payment to:</p>
          <p><strong>Account Number:</strong> 0300-1234567</p>
          <p><strong>Account Name:</strong> Timeless Trends</p>
          <p>After payment, share transaction ID via WhatsApp at 0300-1234567</p>
        </div>
        
        <div class="checkout-actions">
          <button class="btn-back" onclick="goToStep(2)">Back</button>
          <button class="btn-confirm" onclick="confirmOrder()">Confirm Order</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Popup Notification -->
  <div id="popup" class="popup">Item added to cart!</div>
  <script src="coupons.js"></script>
  <script src="products.js"></script>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDjbEkfu8fJmPTDQ8xksGehPday9lrcSrg",
      authDomain: "abdullah-bb8ab.firebaseapp.com",
      projectId: "abdullah-bb8ab",
      storageBucket: "abdullah-bb8ab.appspot.com",
      messagingSenderId: "286504008164",
      appId: "1:286504008164:web:8642bc9d56f36393052ff1"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // App State
    let cart = {};
    let wishlist = [];
    let darkMode = false;
    let currentUser = null;
    let appliedCoupon = null;

    // Product Data
    
    // Valid Coupons
   

    // DOM Elements
    const authModal = document.getElementById("authModal");
    const loginForm = document.getElementById("loginForm");
    const signupForm = document.getElementById("signupForm");
    const loginError = document.getElementById("loginError");
    const signupError = document.getElementById("signupError");
    const userGreeting = document.getElementById("userGreeting");
    const authButton = document.getElementById("authButton");
    const productList = document.getElementById("product-list");
    const cartModal = document.getElementById("cartModal");
    const cartItemsList = document.getElementById("cartItems");
    const totalPriceElem = document.getElementById("totalPrice");
    const popup = document.getElementById("popup");
    const checkoutModal = document.getElementById("checkoutModal");

    // Initialize the app
    function init() {
      loadCart();
      loadWishlist();
      renderProducts();
      checkAuthState();
      setupPaymentListeners();
      setupProvinceCityMapping();
      
      // Check for saved dark mode preference
      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
        darkMode = true;
      }
    }

    // Setup payment method listeners
    function setupPaymentListeners() {
      document.getElementById('easyPaisa').addEventListener('change', function() {
        document.getElementById('easyPaisaDetails').classList.toggle('active', this.checked);
      });
      
      document.getElementById('jazzcash').addEventListener('change', function() {
        document.getElementById('jazzcashDetails').classList.toggle('active', this.checked);
      });
      
      document.querySelectorAll('input[name="payment"]').forEach(radio => {
        radio.addEventListener('change', function() {
          document.querySelectorAll('.payment-details').forEach(detail => {
            detail.classList.remove('active');
          });
          if (this.id === 'easyPaisa') {
            document.getElementById('easyPaisaDetails').classList.add('active');
          } else if (this.id === 'jazzcash') {
            document.getElementById('jazzcashDetails').classList.add('active');
          }
        });
      });
    }

    // Check authentication state
    function checkAuthState() {
  auth.onAuthStateChanged(user => {
    currentUser = user;
    const authButton = document.getElementById("authButton");
    const userGreeting = document.getElementById("userGreeting");
    
    if (user) {
      // User is signed in
      userGreeting.textContent = `Hello, ${user.displayName || user.email.split('@')[0]}`;
      userGreeting.style.display = "inline";
      authButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
      authButton.onclick = logout;
      
      // Load user's data
      loadUserCart(user.uid);
      loadUserWishlist(user.uid);
    } else {
      // User is signed out
      userGreeting.textContent = "";
      userGreeting.style.display = "none";
      authButton.innerHTML = '<i class="far fa-user"></i> Login';
      authButton.onclick = openAuthModal;
    }
  });
}


    // Render products to the page
    function renderProducts() {
      productList.innerHTML = "";
      
      products.forEach(product => {
        const isInWishlist = wishlist.includes(product.id);
        const productCard = document.createElement("div");
        productCard.className = "product-card";
        productCard.setAttribute('data-id', product.id);
        productCard.setAttribute("data-name", product.name.toLowerCase());
        productCard.setAttribute("data-category", product.category);
        productCard.setAttribute("data-price", product.price);
        
        productCard.innerHTML = `
          <img src="${product.image}" alt="${product.name}">
          <h3>${product.name}</h3>
          <p>PKR ${product.price.toLocaleString()}</p>
          <p>${product.stock > 0 ? `${product.stock} in stock` : 'Out of stock'}</p>
          <div class="product-actions">
            <button class="wishlist-btn ${isInWishlist ? 'active' : ''}" onclick="toggleWishlist('${product.id}')">
              ${isInWishlist ? '❤️' : '🤍'}
            </button>
            <button class="cart-button" onclick="addToCart('${product.id}', '${product.name}', ${product.price}, '${product.image}')" 
              ${product.stock <= 0 ? 'disabled' : ''}>
              <i class="fas fa-cart-plus"></i> Add to Cart
            </button>
          </div>
        `;
        
        productList.appendChild(productCard);
      });
    }

    // Auth Modal Functions
    function openAuthModal() {
      authModal.style.display = "flex";
    }

    function closeAuthModal() {
      authModal.style.display = "none";
      loginError.textContent = "";
      signupError.textContent = "";
    }

    function switchAuthTab(tab) {
      if (tab === "login") {
        document.querySelector(".auth-tab:nth-child(1)").classList.add("active");
        document.querySelector(".auth-tab:nth-child(2)").classList.remove("active");
        loginForm.classList.add("active");
        signupForm.classList.remove("active");
      } else {
        document.querySelector(".auth-tab:nth-child(1)").classList.remove("active");
        document.querySelector(".auth-tab:nth-child(2)").classList.add("active");
        loginForm.classList.remove("active");
        signupForm.classList.add("active");
      }
    }

    // Authentication Functions
    function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      
      if (!email || !password) {
        loginError.textContent = "Please enter both email and password";
        return;
      }
      
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          closeAuthModal();
        })
        .catch(error => {
          loginError.textContent = error.message;
        });
    }

    function signup() {
      const name = document.getElementById("signupName").value;
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      const confirmPassword = document.getElementById("signupConfirmPassword").value;
      
      if (!name || !email || !password || !confirmPassword) {
        signupError.textContent = "Please fill all fields";
        return;
      }
      
      if (password !== confirmPassword) {
        signupError.textContent = "Passwords don't match";
        return;
      }
      
      if (password.length < 6) {
        signupError.textContent = "Password should be at least 6 characters";
        return;
      }
      
      auth.createUserWithEmailAndPassword(email, password)
        .then(cred => {
          return cred.user.updateProfile({
            displayName: name
          });
        })
        .then(() => {
          closeAuthModal();
        })
        .catch(error => {
          signupError.textContent = error.message;
        });
    }

    function logout() {
      auth.signOut()
        .then(() => {
          // Save cart to localStorage when logging out
          saveCart();
          saveWishlist();
        })
        .catch(error => {
          console.error("Logout error:", error);
        });
    }

    // Cart Functions
    function addToCart(productId, productName, price, image) {
      if (!currentUser) {
        openAuthModal();
        return;
      }
      
      if (cart[productId]) {
        cart[productId].quantity += 1;
      } else {
        cart[productId] = { 
          name: productName, 
          price: price, 
          quantity: 1, 
          image: image 
        };
      }
      
      showPopup(`${productName} added to cart!`);
      saveCart();
      
      // If user is logged in, save to Firestore
      if (currentUser) {
        saveUserCart(currentUser.uid);
      }
    }

    function removeFromCart(productId) {
      if (cart[productId]) {
        delete cart[productId];
        saveCart();
        openCart();
        
        // If user is logged in, save to Firestore
        if (currentUser) {
          saveUserCart(currentUser.uid);
        }
      }
    }

    function updateQuantity(productId, change) {
      if (cart[productId]) {
        cart[productId].quantity += change;
        
        if (cart[productId].quantity <= 0) {
          delete cart[productId];
        }
        
        saveCart();
        openCart();
        
        // If user is logged in, save to Firestore
        if (currentUser) {
          saveUserCart(currentUser.uid);
        }
      }
    }

    function openCart() {
      cartItemsList.innerHTML = "";
      let totalPrice = 0;
      
      if (Object.keys(cart).length === 0) {
        cartItemsList.innerHTML = "<p style='text-align: center;'>Your cart is empty</p>";
      } else {
        for (let productId in cart) {
          const item = cart[productId];
          const itemTotal = item.price * item.quantity;
          totalPrice += itemTotal;
          
          const cartItem = document.createElement("div");
          cartItem.className = "cart-item";
          
          cartItem.innerHTML = `
            <div style="display: flex; gap: 10px;">
              <img src="${item.image}" alt="${item.name}">
              <div class="cart-item-info">
                <p class="cart-item-name">${item.name}</p>
                <p class="cart-item-price">PKR ${item.price.toLocaleString()} x ${item.quantity}</p>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <div class="quantity-controls">
                <button class="quantity-btn" onclick="updateQuantity('${productId}', -1)">-</button>
                <span>${item.quantity}</span>
                <button class="quantity-btn" onclick="updateQuantity('${productId}', 1)">+</button>
              </div>
              <button class="remove-btn" onclick="removeFromCart('${productId}')">Remove</button>
            </div>
          `;
          
          cartItemsList.appendChild(cartItem);
        }
      }
      
      // Apply coupon discount if any
      if (appliedCoupon) {
        const discount = totalPrice * appliedCoupon.discount;
        totalPrice -= discount;
        
        totalPriceElem.innerHTML = `
          <span style="text-decoration: line-through;">PKR ${(totalPrice + discount).toLocaleString()}</span>
          PKR ${totalPrice.toLocaleString()}
          <span style="color: green; font-size: 12px;">(${appliedCoupon.code} applied - ${appliedCoupon.discount * 100}% off)</span>
        `;
      } else {
        totalPriceElem.textContent = totalPrice.toLocaleString();
      }
      
      cartModal.style.display = "flex";
    }

    function closeCart() {
      cartModal.style.display = "none";
    }

    function saveCart() {
      localStorage.setItem("timelessTrendsCart", JSON.stringify(cart));
    }

    function loadCart() {
      const savedCart = localStorage.getItem("timelessTrendsCart");
      if (savedCart) {
        cart = JSON.parse(savedCart);
      }
    }

    function saveUserCart(userId) {
      db.collection("userCarts").doc(userId).set({
        cart: cart,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      })
      .catch(error => {
        console.error("Error saving cart:", error);
      });
    }

    function loadUserCart(userId) {
      db.collection("userCarts").doc(userId).get()
        .then(doc => {
          if (doc.exists) {
            cart = doc.data().cart || {};
          }
        })
        .catch(error => {
          console.error("Error loading cart:", error);
        });
    }

    // Wishlist Functions
    function toggleWishlist(productId) {
      if (!currentUser) {
        openAuthModal();
        return;
      }
      
      const index = wishlist.indexOf(productId);
      if (index === -1) {
        wishlist.push(productId);
      } else {
        wishlist.splice(index, 1);
      }
      
      saveWishlist();
      renderProducts();
      
      // If user is logged in, save to Firestore
      if (currentUser) {
        saveUserWishlist(currentUser.uid);
      }
    }

    function viewWishlist() {
      if (!currentUser) {
        openAuthModal();
        return;
      }
      
      const wishlistContainer = document.createElement("div");
      wishlistContainer.className = "modal";
      wishlistContainer.innerHTML = `
        <div class="modal-content">
          <span class="close-btn" onclick="this.parentElement.parentElement.remove()">&times;</span>
          <h2>Your Wishlist</h2>
          <div id="wishlistItems" style="margin-top: 15px;"></div>
        </div>
      `;
      
      const wishlistItems = wishlistContainer.querySelector("#wishlistItems");
      
      if (wishlist.length === 0) {
        wishlistItems.innerHTML = "<p style='text-align: center;'>Your wishlist is empty</p>";
      } else {
        wishlist.forEach(productId => {
          const product = products.find(p => p.id === productId);
          if (product) {
            const item = document.createElement("div");
            item.className = "cart-item";
            item.innerHTML = `
              <div style="display: flex; gap: 10px;">
                <img src="${product.image}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">
                <div>
                  <p style="font-weight: 500;">${product.name}</p>
                  <p style="font-size: 12px; color: #666;">PKR ${product.price.toLocaleString()}</p>
                </div>
              </div>
              <div style="display: flex; gap: 10px;">
                <button class="cart-button" onclick="addToCart('${product.id}', '${product.name}', ${product.price}, '${product.image}')">
                  <i class="fas fa-cart-plus"></i>
                </button>
                <button class="remove-btn" onclick="removeFromWishlist('${product.id}', this.parentElement.parentElement.parentElement)">
                  Remove
                </button>
              </div>
            `;
            wishlistItems.appendChild(item);
          }
        });
      }
      
      document.body.appendChild(wishlistContainer);
      wishlistContainer.style.display = "flex";
    }

    function removeFromWishlist(productId, container) {
      const index = wishlist.indexOf(productId);
      if (index !== -1) {
        wishlist.splice(index, 1);
        saveWishlist();
        
        // Update the wishlist view
        if (container) {
          container.remove();
        } else {
          viewWishlist();
        }
        
        // Update the heart icon in product cards
        const productCards = document.querySelectorAll('.product-card');
        productCards.forEach(card => {
          if (card.getAttribute('data-id') === productId) {
            const heartBtn = card.querySelector('.wishlist-btn');
            if (heartBtn) {
              heartBtn.classList.remove('active');
              heartBtn.textContent = '🤍';
            }
          }
        });
        
        // If user is logged in, update Firestore
        if (currentUser) {
          saveUserWishlist(currentUser.uid);
        }
      }
    }

    function saveWishlist() {
      localStorage.setItem("timelessTrendsWishlist", JSON.stringify(wishlist));
    }

    function loadWishlist() {
      const savedWishlist = localStorage.getItem("timelessTrendsWishlist");
      if (savedWishlist) {
        wishlist = JSON.parse(savedWishlist);
      }
    }

    function saveUserWishlist(userId) {
      db.collection("userWishlists").doc(userId).set({
        wishlist: wishlist,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      })
      .catch(error => {
        console.error("Error saving wishlist:", error);
      });
    }

    function loadUserWishlist(userId) {
      db.collection("userWishlists").doc(userId).get()
        .then(doc => {
          if (doc.exists) {
            wishlist = doc.data().wishlist || [];
            renderProducts();
          }
        })
        .catch(error => {
          console.error("Error loading wishlist:", error);
        });
    }

    // Coupon Functions
    function applyCoupon() {
      const couponCode = document.getElementById("couponCode").value.toUpperCase();
      const couponMessage = document.getElementById("couponMessage");
      
      if (!couponCode) {
        couponMessage.textContent = "Please enter a coupon code";
        couponMessage.style.color = "red";
        return;
      }
      
      if (validCoupons[couponCode]) {
        appliedCoupon = {
          code: couponCode,
          discount: validCoupons[couponCode]
        };
        couponMessage.textContent = `Coupon applied! ${appliedCoupon.discount * 100}% discount`;
        couponMessage.style.color = "green";
        openCart();
      } else {
        appliedCoupon = null;
        couponMessage.textContent = "Invalid coupon code";
        couponMessage.style.color = "red";
        openCart();
      }
    }

    // Checkout Functions
    function openCheckout() {
      if (!currentUser) {
        openAuthModal();
        return;
      }
      
      if (Object.keys(cart).length === 0) {
        alert("Your cart is empty!");
        return;
      }
      
      // Pre-fill user data
      document.getElementById('checkoutEmail').value = currentUser.email;
      if (currentUser.displayName) {
        document.getElementById('checkoutName').value = currentUser.displayName;
      }
      
      // Reset steps
      document.querySelectorAll('.checkout-step').forEach((el, index) => {
        el.classList.remove('active', 'completed');
        if (index === 0) el.classList.add('active');
      });
      
      document.querySelectorAll('.checkout-section').forEach(el => {
        el.classList.remove('active');
      });
      document.getElementById('section1').classList.add('active');
      
      checkoutModal.style.display = "flex";
    }

    function closeCheckout() {
      checkoutModal.style.display = "none";
    }

    function goToStep(step) {
      // Validate current step before proceeding
      if (step === 2 && !validateStep1()) return;
      if (step === 3 && !validateStep2()) return;
      
      // Update active steps
      document.querySelectorAll('.checkout-step').forEach((el, index) => {
        el.classList.remove('active');
        if (index < step - 1) el.classList.add('completed');
        if (index === step - 1) el.classList.add('active');
      });
      
      // Update active sections
      document.querySelectorAll('.checkout-section').forEach(el => {
        el.classList.remove('active');
      });
      document.getElementById(`section${step}`).classList.add('active');
    }
    
    function validateStep1() {
      const email = document.getElementById('checkoutEmail').value;
      const name = document.getElementById('checkoutName').value;
      const address = document.getElementById('checkoutAddress').value;
      const city = document.getElementById('checkoutCity').value;
      const province = document.getElementById('checkoutProvince').value;
      const phone = document.getElementById('checkoutContact').value;
      
      if (!email || !name || !address || !city || !province || !phone) {
        alert('Please fill all required fields');
        return false;
      }
      
      if (!/^\d{10,15}$/.test(phone)) {
        alert('Please enter a valid phone number (10-15 digits)');
        return false;
      }
      
      return true;
    }
    
    function validateStep2() {
      // Shipping method validation if needed
      return true;
    }
    
    
    async function confirmOrder() {
  try {
    // Show loading state
    const confirmBtn = document.querySelector('.btn-confirm');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

    // Validate all fields
    const name = document.getElementById('checkoutName').value.trim();
    const email = document.getElementById('checkoutEmail').value.trim();
    const address = document.getElementById('checkoutAddress').value.trim();
    const city = document.getElementById('checkoutCity').value.trim();
    const province = document.getElementById('checkoutProvince').value;
    const phone = document.getElementById('checkoutContact').value.trim();
    const paymentMethod = document.querySelector('input[name="payment"]:checked');

    if (!name || !email || !address || !city || !province || !phone) {
      throw new Error('Please fill all required fields');
    }

    if (!/^\d{10,15}$/.test(phone)) {
      throw new Error('Please enter a valid phone number (10-15 digits)');
    }

    if (!paymentMethod) {
      throw new Error('Please select a payment method');
    }

    // Calculate order totals
    let subtotal = 0;
    for (let productId in cart) {
      subtotal += cart[productId].price * cart[productId].quantity;
    }

    const shippingFee = document.getElementById('expressShipping').checked ? 800 : 300;
    const freeShipping = subtotal >= 10000;
    let discountAmount = appliedCoupon ? subtotal * appliedCoupon.discount : 0;
    const total = subtotal - discountAmount + (freeShipping ? 0 : shippingFee);

    // Prepare order data
    const orderDetails = {
      userId: currentUser.uid,
      userEmail: email,
      userName: name,
      userContact: phone,
      shippingAddress: {
        address: address,
        city: city,
        province: province
      },
      shippingMethod: document.querySelector('input[name="shipping"]:checked').id,
      shippingFee: freeShipping ? 0 : shippingFee,
      paymentMethod: paymentMethod.id,
      products: cart,
      subtotal: subtotal,
      discount: appliedCoupon ? {
        code: appliedCoupon.code,
        amount: discountAmount
      } : null,
      total: total,
      status: "pending",
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Save order to Firestore
    const orderRef = await db.collection("orders").add(orderDetails);
    console.log("Order placed with ID: ", orderRef.id);
  

    // Send email via Web3Forms
    await sendOrderEmail(orderDetails, orderRef.id);
    // Clear cart and coupon
    cart = {};
    saveCart();
    appliedCoupon = null;

    // Show success message
    const checkoutMain = document.querySelector('.checkout-section.active');
    checkoutMain.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <div style="font-size: 60px; color: #4CAF50; margin-bottom: 20px;">
          <i class="fas fa-check-circle"></i>
        </div>
        <h2 style="margin-bottom: 15px;">Order Confirmed!</h2>
        <p style="margin-bottom: 10px;">Thank you for your purchase!</p>
        <p style="margin-bottom: 20px;">Order #${orderRef.id}</p>
        <p style="margin-bottom: 30px;">
          A confirmation has been sent to ${email}
        </p>
        <button onclick="closeCheckout(); closeCart(); window.location.reload();" 
                style="background: #8a2387; color: white; border: none; 
                       padding: 12px 30px; border-radius: 4px; cursor: pointer;
                       font-size: 16px;">
          Continue Shopping
        </button>
      </div>
    `;

  } catch (error) {
    console.error("Order error:", error);
    alert(error.message || "Failed to place order. Please try again.");
    
    // Reset button state
    const confirmBtn = document.querySelector('.btn-confirm');
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Confirm Order';
    }
  }
}
async function sendOrderEmail(orderDetails, orderId) {
  const web3formEndpoint = "https://api.web3forms.com/submit";
  const accessKey = "8847c3a9-5ac4-4b89-b85a-6bba70de7550";

  // Format products list
  const productsList = Object.values(orderDetails.products)
    .map(item => `${item.name} (Qty: ${item.quantity}) - PKR ${item.price * item.quantity}`)
    .join("\n");

  // Plain text email content
  const emailData = {
    access_key: accessKey,
    subject: `New Order #${orderId} - Timeless Trends`,
    from_name: "Timeless Trends Store",
    name: orderDetails.userName,
    email: orderDetails.userEmail,
    order_id: orderId,
    replyto: orderDetails.userEmail,
    content_type: "text", // Force plain text
    message: `
NEW ORDER RECEIVED

Order ID: ${orderId}
Customer: ${orderDetails.userName}
Email: ${orderDetails.userEmail}
Phone: ${orderDetails.userContact}

SHIPPING ADDRESS:
${orderDetails.shippingAddress.address}
${orderDetails.shippingAddress.city}, ${orderDetails.shippingAddress.province}

ORDER DETAILS:
${productsList}

Subtotal: PKR ${orderDetails.subtotal.toLocaleString()}
${orderDetails.discount ? `Discount (${orderDetails.discount.code}): -PKR ${orderDetails.discount.amount.toLocaleString()}\n` : ''}
Shipping: PKR ${orderDetails.shippingFee.toLocaleString()}
Total: PKR ${orderDetails.total.toLocaleString()}

PAYMENT METHOD:
${orderDetails.paymentMethod.replace(/([A-Z])/g, ' $1').trim()}
    `.trim()
  };

  try {
    const response = await fetch(web3formEndpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(emailData)
    });
    
    const result = await response.json();
    if (!response.ok) {
      console.error("Email failed:", result);
    } else {
      console.log("Email sent successfully");
    }
  } catch (error) {
    console.error("Email error:", error);
  }
}
    // Province-City Mapping
    function setupProvinceCityMapping() {
      const cities = {
        "Punjab": [
          "Lahore", "Faisalabad", "Rawalpindi", "Multan", "Gujranwala", "Sialkot",
          "Sargodha", "Bahawalpur", "Sheikhupura", "Rahim Yar Khan", "Jhang",
          "Sahiwal", "Okara", "Gujrat", "Kasur", "Mandi Bahauddin", "Vehari",
          "Hafizabad", "Dera Ghazi Khan", "Chiniot", "Khanewal", "Bhakkar",
          "Muzaffargarh", "Toba Tek Singh", "Lodhran", "Attock", "Pakpattan",
          "Narowal", "Khushab", "Mianwali", "Jhelum", "Bahawalnagar", "Rajanpur",
          "Nankana Sahib", "Chakwal", "Layyah"
        ],
        "Sindh": [
          "Karachi", "Hyderabad", "Sukkur", "Larkana", "Nawabshah", "Mirpurkhas",
          "Khairpur", "Ghotki", "Dadu", "Jacobabad", "Shikarpur", "Thatta",
          "Badin", "Tando Adam", "Umerkot", "Tando Allahyar", "Matiari",
          "Qambar Shahdadkot", "Kashmore", "Jamshoro", "Sanghar"
        ],
        "KPK": [
          "Peshawar", "Abbottabad", "Mardan", "Swat", "Kohat", "Bannu",
          "Dera Ismail Khan", "Charsadda", "Nowshera", "Haripur", "Swabi",
          "Mansehra", "Batkhela", "Timergara", "Buner", "Hangu", "Karak",
          "Lakki Marwat", "Shangla", "Tank", "Upper Dir", "Lower Dir", "Torghar",
          "Chitral"
        ],
        "Balochistan": [
          "Quetta", "Gwadar", "Turbat", "Khuzdar", "Sibi", "Zhob", "Chaman",
          "Kalat", "Mastung", "Nushki", "Panjgur", "Kharan", "Loralai", "Dera Bugti",
          "Jafarabad", "Lasbela", "Musakhel", "Barkhan", "Awaran", "Washuk",
          "Kech", "Ziarat", "Killa Saifullah", "Killa Abdullah", "Harnai"
        ]
      };
      
      document.getElementById("checkoutProvince").addEventListener("change", function() {
        const province = this.value;
        const cityInput = document.getElementById("checkoutCity");
        
        if (province && cities[province]) {
          // Create datalist for cities
          let datalist = document.getElementById("citiesDatalist");
          if (!datalist) {
            datalist = document.createElement("datalist");
            datalist.id = "citiesDatalist";
            document.body.appendChild(datalist);
            cityInput.setAttribute("list", "citiesDatalist");
          }
          
          // Clear existing options
          datalist.innerHTML = '';
          
          // Add new options
          cities[province].forEach(city => {
            const option = document.createElement("option");
            option.value = city;
            datalist.appendChild(option);
          });
        }
      });
    }

    // UI Helper Functions
    function showPopup(message) {
      popup.textContent = message;
      popup.style.display = "block";
      setTimeout(() => {
        popup.style.display = "none";
      }, 2000);
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      darkMode = !darkMode;
      localStorage.setItem("darkMode", darkMode);
    }

    // Initialize the app when DOM is loaded
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>